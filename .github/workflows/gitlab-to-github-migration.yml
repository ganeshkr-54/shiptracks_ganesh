name: GitLab to GitHub Migration

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Setup credentials
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global credential.helper store
          echo "https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.shiptracks.com" > ~/.git-credentials
          echo "https://${GITHUB_TOKEN}:x-oauth-basic@github.com" >> ~/.git-credentials

      - name: Migrate Repositories
        env:
          GITLAB_BASE_URL: "https://gitlab.shiptracks.com"
          GITHUB_BASE_ORG: "shiptracks"
          CSV_FILE: "repos.csv"
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          echo "ğŸš€ Starting migration from CSV: $CSV_FILE"
          output="repos_updated.csv"
          echo "gitlab_repo,github_repo,description,status" > "$output"

          tail -n +2 "$CSV_FILE" | while IFS=',' read -r gitlab_path github_name description status; do
            description="${description//\"/}"
            if [[ -z "$description" ]]; then
              description="Migrated from ${gitlab_path}"
            fi

            if [[ "$status" == "done" ]]; then
              echo "$gitlab_path,$github_name,\"$description\",done" >> "$output"
              continue
            fi

            gitlab_url="${GITLAB_BASE_URL}/${gitlab_path}.git"
            github_url="https://github.com/${GITHUB_BASE_ORG}/${github_name}.git"
            echo "ğŸ“¦ Migrating: $gitlab_path â†’ $github_name"
            if ! gh repo view "${GITHUB_BASE_ORG}/${github_name}" &>/dev/null; then
              gh repo create "${GITHUB_BASE_ORG}/${github_name}" --private --description "$description"
            fi
            tempdir=$(mktemp -d)
            cd "$tempdir"
            if git clone --mirror "$gitlab_url"; then
              cd *.git
              if git push --mirror "$github_url"; then
                echo "$gitlab_path,$github_name,\"$description\",done" >> "${GITHUB_WORKSPACE}/$output"
                echo "ğŸ—ƒ Archiving GitLab repo: $gitlab_path"
                curl --silent --request POST \
                  --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
                  "$GITLAB_BASE_URL/api/v4/projects/$(echo $gitlab_path | sed 's/\//%2F/g')/archive"
              else
                echo "$gitlab_path,$github_name,\"$description\",failed" >> "${GITHUB_WORKSPACE}/$output"
              fi
            else
              echo "$gitlab_path,$github_name,\"$description\",failed" >> "${GITHUB_WORKSPACE}/$output"
            fi
            cd ~
            rm -rf "$tempdir"
          done

          mv "$output" "$CSV_FILE"

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "chore: update migrated repo data"
          title: "chore: update migrated repo data"
          body: |
            ğŸš€ **Automated Migration Update**

            Updated `repos.csv` with latest GitLab â†’ GitHub migration results.

            - âœ… Successful repos marked as *done*
            - âš ï¸ Failed ones marked as *failed*
            - Triggered by `${{ github.actor }}`
            - Run ID: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            _Auto-generated by migration workflow â€” do not edit manually._
          branch: gh-migration-${{ steps.date.outputs.date }}
